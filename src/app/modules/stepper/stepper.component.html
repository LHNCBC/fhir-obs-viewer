<p class="info">
  <span class="info-icon" aria-hidden="true"></span>
  This is a query tool that allows you search a FHIR server to select a cohort of patients,
  and then pull data for those patients.
</p>
<mat-horizontal-stepper linear="true" #stepper>

  <mat-step [completed]="settings.settingsFormGroup.valid" label="Settings" state="edit">
    <div class="v-box">
      <app-settings-page #settings></app-settings-page>
      <div class="spacer"></div>
      <div class="h-box">
        <button mat-stroked-button color="primary" matStepperNext type="button">
          Select an action
          <mat-icon svgIcon="keyboard_arrow_right"></mat-icon>
        </button>
      </div>
    </div>
  </mat-step>

  <mat-step label="Select an action" state="edit">
    <div class="v-box">
      <app-select-an-action #selectAnActionComponent></app-select-an-action>
      <div class='spacer'></div>
      <div class="h-box">
        <button mat-stroked-button color="primary" matStepperPrevious>
          <mat-icon svgIcon="keyboard_arrow_left"></mat-icon>Settings
        </button>
        <div class='spacer'></div>
        <button mat-stroked-button color="primary"
                matStepperNext
                type="button">
          Public data<mat-icon svgIcon="keyboard_arrow_right"></mat-icon>
        </button>
        <div class='spacer'></div>
        <button mat-stroked-button color="primary"
                matStepperNext
                type="button">
          Controlled access<mat-icon svgIcon="keyboard_arrow_right"></mat-icon>
        </button>
      </div>
    </div>
  </mat-step>

  <mat-step *ngIf="fhirBackend.features.hasResearchStudy && selectAnActionComponent.createCohortMode.value === CreateCohortMode.SEARCH"
            label="Select Research Studies" state="edit" optional>
    <div class="v-box">
      <app-select-an-area-of-interest #selectAnAreaOfInterest>
      </app-select-an-area-of-interest>
      <div class="spacer"></div>
      <div class="h-box">
        <button mat-stroked-button color="primary" matStepperPrevious>
          <mat-icon svgIcon="keyboard_arrow_left"></mat-icon>Select an action
        </button>
        <div class='spacer'></div>
        <button mat-stroked-button (click)='hiddenFileInput2.click()'>
          <mat-icon svgIcon='upload'></mat-icon>
          Load cohort and criteria
        </button>
        <input type='file' #hiddenFileInput2 style='display: none;' (change)='loadCohort($event, true)'>
        <div class="spacer" *ngIf="selectAnAreaOfInterest.showTable"></div>
        <button mat-stroked-button *ngIf="selectAnAreaOfInterest.showTable"
                (click)="columnDescriptions.openColumnsDialog('ResearchStudy')">
          <mat-icon svgIcon="create"></mat-icon>
          Configure table
        </button>
        <div class="spacer"></div>
        <button mat-stroked-button color="primary" matStepperNext type="button">
          Define cohort<mat-icon svgIcon="keyboard_arrow_right"></mat-icon>
        </button>
      </div>
    </div>
  </mat-step>

  <mat-step label="Select records"
            *ngIf="selectAnActionComponent.createCohortMode.value === CreateCohortMode.BROWSE">
    <div class="v-box">
      <app-select-records-page></app-select-records-page>
      <div class="spacer"></div>
      <div class="h-box">
        <button mat-stroked-button color="primary" matStepperPrevious>
          <mat-icon svgIcon="keyboard_arrow_left"></mat-icon>
          Select an action
        </button>
        <div class='spacer'></div>
        <button mat-stroked-button (click)='hiddenFileInput3.click()'>
          <mat-icon svgIcon='upload'></mat-icon>
          Load cohort and criteria
        </button>
        <input type='file' #hiddenFileInput3 style='display: none;' (change)='loadCohort($event)'>
        <div class="spacer"></div>
        <!-- We can't use the matStepperNext directive, but we need to treat this
         button as the "next button" in e2e tests. To do this, the mat-stepper-next
         class has been added. MatStepperNextHarness uses this class. -->
        <button mat-stroked-button color="primary" class="mat-stepper-next"
                (click)="searchForPatients()">
          Search for Patients<mat-icon svgIcon="keyboard_arrow_right"></mat-icon>
        </button>
      </div>
    </div>
  </mat-step>

  <mat-step #defineCohortStep label="Define cohort"
            *ngIf="selectAnActionComponent.createCohortMode.value === CreateCohortMode.SEARCH">
      <app-define-cohort-page
        [formControl]="defineCohort"></app-define-cohort-page>
      <div class="h-box">
        <button mat-stroked-button color="primary" matStepperPrevious>
          <mat-icon svgIcon="keyboard_arrow_left"></mat-icon>
          {{fhirBackend.features.hasResearchStudy ? 'Select Research Studies' : 'Select an action'}}
        </button>
        <div class='spacer'></div>
        <button mat-stroked-button (click)='hiddenFileInput.click()'>
          <mat-icon svgIcon='upload'></mat-icon>
          Load cohort and criteria
        </button>
        <input type='file' id='hiddenFileInput' #hiddenFileInput style='display: none;' (change)='loadCohort($event)'>
        <div class="spacer"></div>
        <!-- We can't use the matStepperNext directive, but we need to treat this
         button as the "next button" in e2e tests. To do this, the mat-stepper-next
         class has been added. MatStepperNextHarness uses this class. -->
        <button mat-stroked-button color="primary" class="mat-stepper-next"
                (click)="searchForPatients()">
          Search for Patients<mat-icon svgIcon="keyboard_arrow_right"></mat-icon>
        </button>
      </div>
  </mat-step>

  <mat-step label="View cohort"
            *ngIf="selectAnActionComponent.createCohortMode.value !== CreateCohortMode.UNSELECTED">
    <div class="v-box">
      <app-view-cohort-page #viewCohortComponent>
      </app-view-cohort-page>
      <div class="spacer"></div>
      <div class="h-box">
        <button mat-stroked-button color="primary" matStepperPrevious>
          <mat-icon svgIcon="keyboard_arrow_left"></mat-icon>Define cohort
        </button>
        <div class="spacer"></div>
        <button mat-stroked-button (click)="saveCohort()" [disabled]="cohort.currentState.loading">
          <mat-icon svgIcon="save"></mat-icon>Save the cohort and criteria for later
        </button>
        <div class="spacer"></div>
        <button mat-stroked-button>
          <mat-icon svgIcon="refresh"></mat-icon>Reload
        </button>
        <div class="spacer"></div>
        <button mat-stroked-button (click)="columnDescriptions.openColumnsDialog('Patient')">
          <mat-icon svgIcon="create"></mat-icon>Configure table
        </button>
        <div class="spacer"></div>
        <button mat-stroked-button color="primary" matStepperNext>
          Pull data for the cohort<mat-icon svgIcon="keyboard_arrow_right"></mat-icon>
        </button>
      </div>
    </div>
  </mat-step>

  <mat-step label="Pull data for the cohort" *ngIf="selectAnActionComponent.createCohortMode.value !== CreateCohortMode.UNSELECTED">
    <div class="v-box">
      <app-pull-data-page #pullDataPageComponent
                          [defaultObservationCodes]="pullData.defaultObservationCodes$ | async">
      </app-pull-data-page>
      <div class="spacer"></div>
      <div class="h-box">
        <button mat-stroked-button color="primary" matStepperPrevious>
          <mat-icon svgIcon="keyboard_arrow_left"></mat-icon>View cohort
        </button>
        <div class="spacer"></div>
        <button mat-stroked-button (click)="pullDataPageComponent.configureColumns()">
          <mat-icon svgIcon="create"></mat-icon>Configure table
        </button>
        <div class="spacer"></div>
        <button mat-stroked-button (click)="pullDataPageComponent.downloadCsv()"
                [disabled]="!pullData.getHasLoadedData(pullDataPageComponent.currentResourceType$ | async)">
          <mat-icon svgIcon="file_download"></mat-icon>Download(in CSV format)
        </button>
        <div class="spacer"></div>
      </div>
    </div>
  </mat-step>

  <ng-template matStepperIcon="edit">
    <mat-icon svgIcon="create"></mat-icon>
  </ng-template>
</mat-horizontal-stepper>
