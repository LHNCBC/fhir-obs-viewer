<ng-container *ngIf="prefixTemplate as template">
  <ng-container *ngTemplateOutlet="template; context: templateContext"></ng-container>
</ng-container>

<mat-progress-bar
    *ngIf="loading"
    [mode]="(progressBarPosition$ | async) > 0 ? 'determinate' : 'indeterminate'"
    [value]="progressBarPosition$ | async">
</mat-progress-bar>
<ng-container *ngIf="headerTemplate as template; else defaultTitle">
  <ng-container *ngTemplateOutlet="template; context: templateContext"></ng-container>
</ng-container>
<ng-template #defaultTitle>
  <mat-accordion>
    <mat-expansion-panel hideToggle #panel>
      <mat-expansion-panel-header
          (click)="!loadingStatistics.length && panel.toggle()"
          (keydown.enter)="!loadingStatistics.length && panel.toggle()"
          (keydown.space)="!loadingStatistics.length && panel.toggle()">
        <mat-panel-title>
        <span *ngIf="resourceType === 'Patient' && !loading; else countTemplate">
          Cohort of&nbsp;{{dataSource.data.length}} {{resourceType}} resources
        </span>
          <ng-template #countTemplate>
            <span>{{countMessage}}</span>
          </ng-template>
        </mat-panel-title>
        <mat-panel-description>
          <span *ngIf="loading; else loadedTemplate">
            <span>{{loadingMessage}}</span>
          </span>
          <ng-template #loadedTemplate>
            Data loaded on {{loadedDateTime | date: 'short'}} in {{loadTime}} seconds
            <span *ngIf="loadingStatistics?.length">&nbsp;(click to view/hide details)</span>
          </ng-template>
        </mat-panel-description>
      </mat-expansion-panel-header>
      <table *ngIf="loadingStatistics?.length" id="loadingStatistics">
        <tr *ngFor="let row of loadingStatistics">
          <td *ngFor="let item of row">{{item}}</td>
        </tr>
      </table>
    </mat-expansion-panel>
  </mat-accordion>
</ng-template>

<div class="container" *ngIf="this.dataSource.data.length > 0 || context === 'browse' || context === 'select'">
  <div class="buttons-container">
  <ng-container *ngIf="buttonPrefixTemplate as template">
    <ng-container *ngTemplateOutlet="template; context: templateContext"></ng-container>
  </ng-container>

  <button mat-mini-fab
          color="basic"
          *ngIf="context === 'browse' || context==='select'"
          [disabled]="loading || !(enableFiltering ? dataSource.filteredData : dataSource.data).length"
          (click)="downloadCsv()"
          matTooltip="Download (in CSV format)">
    <mat-icon svgIcon="file_download"></mat-icon>
  </button>

  <button mat-mini-fab
          color="basic"
          type="button" mat-icon-button
          *ngIf="context === 'browse' || context==='select'"
          (click)="columnDescriptionsService.openColumnsDialog(resourceTypeColumns || resourceType, context)"
          matTooltip="Configure table">
    <mat-icon svgIcon="settings"></mat-icon>
  </button>
  <button mat-mini-fab
          color="basic"
          [matTooltip]="fullscreen ? 'Exit full screen mode' : 'Expand the table to full screen'"
          [attr.aria-label]="fullscreen ? 'Exit full screen mode' : 'Expand the table to full screen'"
          (click)="toggleFullscreen()">
    <mat-icon [svgIcon]="fullscreen ? 'fullscreen_exit_black' : 'fullscreen_black'"></mat-icon>
  </button>
  </div>
  <cdk-virtual-scroll-viewport tvsItemSize class="table-container mat-elevation-z4"
                               [class.table-container-with-prefix]="!!prefixTemplate"
                               (scroll)="onScroll()">
    <table mat-table matSort matSortDisableClear matSortStart='desc' [dataSource]="dataSource"
           [matSortActive]="sort?.active" [matSortDirection]="sort?.direction"
           class="cell-text-no-wrap"
           [class.highlightable]="highlightSelection"
           (matSortChange)="sortData($event)">
      <!-- Row action column -->
      <ng-container matColumnDef="action">
        <th mat-header-cell *matHeaderCellDef class="cell-with-icon" width="28">
          <!-- Do we need a header for the action column? -->
        </th>
        <td mat-cell *matCellDef="let row" class="cell-with-icon">
          <ng-container *ngIf="rowActionTemplate as template">
            <ng-container *ngTemplateOutlet="template; context: {templateContext, row}"></ng-container>
          </ng-container>
        </td>
      </ng-container>
      <!-- Select checkbox column -->
      <ng-container matColumnDef="select">
        <th mat-header-cell *matHeaderCellDef class="cell-with-icon" width="28">
          <mat-checkbox *ngIf="!selectAny"
                        (change)="$event ? masterToggle() : null"
                        [checked]="selectedResources.hasValue() && isAllSelected()"
                        [indeterminate]="selectedResources.hasValue() && !isAllSelected()"
                        matTooltip='Select/Unselect all'>
          </mat-checkbox>
          <button type="button" mat-icon-button
                  *ngIf="selectAny"
                  class="clear-btn"
                  (click)="clearSelection()"
                  [disabled]="!this.selectedResources.selected.length"
                  matTooltip="Clear selection">
            <mat-icon svgIcon="remove_done_black"></mat-icon>
          </button>
        </th>
        <td mat-cell *matCellDef="let row" class="cell-with-icon">
          <mat-checkbox *ngIf='selectAny || myStudyIds.includes(row.resource.id)'
                        (click)="checkboxClick($event, row)"
                        (change)="$event ? selectedResources.toggle(row.resource) : null"
                        [checked]="selectedResources.isSelected(row.resource)"
                        [attr.aria-label]="checkboxTooltipText"
                        [matTooltip]="checkboxTooltipText">
          </mat-checkbox>
        </td>
      </ng-container>

      <!-- Data Columns -->
      <ng-container *ngFor="let column of columnDescriptions" [matColumnDef]="column.element">
        <ng-container *ngIf="isSortable(column); else noSort">
          <th mat-header-cell *matHeaderCellDef mat-sort-header="" title='click on header to sort by this column'>
            <span [attr.aria-label]="column.displayName + '. click to sort by this column.'">
              {{column.displayName}}
            </span>
            <button *ngIf='column.description'
                    title=""
                    aria-label="column info"
                    #tooltip="matTooltip"
                    (focus)="onInfoIconFocus(tooltip)"
                    (mouseenter)="onInfoIconFocus(tooltip)"
                    (click)="onInfoIconClick($event, tooltip)"
                    (keydown.enter)="onInfoIconClick($event, tooltip)"
                    (keydown.space)="onInfoIconClick($event, tooltip)"
                    [matTooltip]='column.description' matTooltipPosition='above'>
              <mat-icon svgIcon='info'></mat-icon>
            </button>
            <button *ngIf='enableFiltering && column.filterable !== false' aria-label='open filter criteria for this column'
                    title='open filter criteria for this column'
                    (click)='openFilterDialog($event, column)'
                    (keydown.enter)='openFilterDialog($event, column)'
                    (keydown.space)='openFilterDialog($event, column)'>
              <mat-icon [svgIcon]="hasFilter(column.element) ? 'filter_filled' : 'filter_outlined'"></mat-icon>
            </button>
          </th>
        </ng-container>
        <ng-template #noSort>
          <th mat-header-cell *matHeaderCellDef >
            <div class="no-sort-header-container">
              <span [attr.aria-label]="column.displayName + '.'">
                {{column.displayName}}
              </span>
              <button *ngIf='column.description'
                      title=""
                      aria-label="column info"
                      #tooltip="matTooltip"
                      (focus)="onInfoIconFocus(tooltip)"
                      (mouseenter)="onInfoIconFocus(tooltip)"
                      (click)="onInfoIconClick($event, tooltip)"
                      (keydown.enter)="onInfoIconClick($event, tooltip)"
                      (keydown.space)="onInfoIconClick($event, tooltip)"
                      [matTooltip]='column.description' matTooltipPosition='above'>
                <mat-icon svgIcon='info'></mat-icon>
              </button>
              <button *ngIf='enableFiltering' aria-label='open filter criteria for this column'
                      title='open filter criteria for this column'
                      (click)='openFilterDialog($event, column)'
                      (keydown.enter)='openFilterDialog($event, column)'
                      (keydown.space)='openFilterDialog($event, column)'>
                <mat-icon [svgIcon]="hasFilter(column.element) ? 'filter_filled' : 'filter_outlined'"></mat-icon>
              </button>
            </div>
          </th>
        </ng-template>

        <td mat-cell *matCellDef="let row">
          <app-ellipsis-text>{{row.cells[column.element]}}</app-ellipsis-text>
        </td>
      </ng-container>

      <!-- TODO: replace with https://github.com/swimlane/ngx-datatable to support IE11 or find another way to support sticky header -->
      <tr mat-header-row *matHeaderRowDef="columns; sticky: true"></tr>
      <tr mat-row
          *matRowDef="let row; columns: columns;"
          [class.anchor-row]="isLastSelected(row)"
          [class.highlight]="highlightSelection && selectedResources.isSelected(row.resource)"
          (mousedown)="onRowMouseDown($event, row)"></tr>
    </table>
  </cdk-virtual-scroll-viewport>
</div>
