<p class="info">
  <span class="info-icon" aria-hidden="true"></span>
  In this step, you can pull cohort data for one or more selected record types and download it.
  Each record type you select will have its own tab in which you can add criteria to limit what is pulled.
</p>

<div class="h-box">
  <button mat-stroked-button
          [disabled]="!unselectedResourceTypes.length"
          [matMenuTriggerFor]="menu">
    <mat-icon svgIcon="add"></mat-icon>Add a new resource tab
  </button>
  <mat-menu #menu="matMenu">
    <button mat-menu-item *ngFor="let resourceType of unselectedResourceTypes"
            (click)="addTab(resourceType)">
      <span>{{resourceType}}</span>
    </button>
  </mat-menu>
  <div class="spacer"></div>
  <button mat-stroked-button
          *ngIf="visibleResourceTypes.length > 1"
          (click)="removeTab(getCurrentResourceType())">
    <mat-icon svgIcon="clear"></mat-icon>{{getRemoveTabButtonText(currentResourceType$ | async)}}
  </button>
</div>

<mat-tab-group dynamicHeight class="mat-elevation-z1">
  <mat-tab *ngFor="let resourceType of visibleResourceTypes" [label]="getPluralFormOfResourceType(resourceType)">
    <div class="v-box tab-content">
      <div class="h-box" *ngIf="resourceType === 'Observation'">
        <mat-checkbox [(ngModel)]="isVariablePatientTable"
                      [disabled]="!pullData.getHasLoadedData('Observation')">
          Convert to Variable-Patient table
        </mat-checkbox>
      </div>
      <div *ngIf="resourceType === 'Observation'" class="spacer"></div>
      <div class="h-box">
        <mat-form-field class="number-field" *ngIf="perPatientFormControls[resourceType]">
          <mat-label>Limit per patient<span *ngIf='resourceType === "Observation"'>&nbsp;per test</span></mat-label>
          <input matInput [formControl]="perPatientFormControls[resourceType]" type="number" min="1">
        </mat-form-field>
        <mat-form-field class="number-field max-recent-observations"
                        *ngIf="resourceType === 'Observation' && !isObsCodesSelected">
          <mat-label>Max recent Observations per Patient to check</mat-label>
          <input matInput [formControl]="maxObservationToCheck" type="number" min="1">
        </mat-form-field>
      </div>

      <div class="h-box for-selected-codes">
        <button mat-stroked-button
                [disabled]="!isValidTab(resourceType) || !cohort.currentState.patients.length"
                [attr.aria-label]='showCodeSelection(resourceType) ? "Load " + getPluralFormOfResourceType(resourceType) + ", optionally limited to the selected codes in the following field" : "Load" + getPluralFormOfResourceType(resourceType)'
                (click)="loadResources(resourceType, resourceParams)">
          <mat-icon svgIcon="refresh"></mat-icon>Load {{getPluralFormOfResourceType(resourceType)}}
        </button>
        <span *ngIf='showCodeSelection(resourceType)'>For selected codes:</span>
        <app-search-parameter-group
            [inputResourceType]='resourceType'
            #resourceParams
            [allowAddRemoveButtons]="false"
            [formControl]="parameterGroups[resourceType]">
        </app-search-parameter-group>
      </div>
      <div class="spacer"></div>
      <app-resource-table *ngIf="(resourceType !== 'Observation' || !isVariablePatientTable) && pullData.resourceStream[resourceType]"
          [columnDescriptions]="columnDescriptions.getVisibleColumns(resourceType, 'pull-data') | async"
          context="pull-data"
          resourceType="{{resourceType}}"
          [loading]="pullData.currentState[resourceType].loading"
          [resources]="pullData.currentState[resourceType].resources"
          [progressValue]="pullData.currentState[resourceType].progressValue"
          [pullDataObservationCodes]="pullDataObservationCodes">
      </app-resource-table>
      <cdk-virtual-scroll-viewport *ngIf="resourceType === 'Observation' && isVariablePatientTable" itemSize="" class="table-container mat-elevation-z4">
        <table mat-table [dataSource]="variablePatientTableDataSource">
          <ng-container *ngFor="let column of variablePatientTableColumns" [matColumnDef]="column">
            <th mat-header-cell *matHeaderCellDef>{{column}}</th>
            <td mat-cell *matCellDef="let row">
              <app-ellipsis-text>{{row.cells[column]}}</app-ellipsis-text>
            </td>
          </ng-container>
          <tr mat-header-row *matHeaderRowDef="variablePatientTableColumns; sticky: true"></tr>
          <tr mat-row *matRowDef="let row; columns: variablePatientTableColumns;"></tr>
        </table>
      </cdk-virtual-scroll-viewport>
    </div>
  </mat-tab>
</mat-tab-group>
